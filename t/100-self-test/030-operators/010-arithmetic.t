#!perl

use v5.42;
use Test::More;
use MXCL::Machine;

my $source = q[
    (require "Test.mxcl")

    (defvar $t (Tester))

    ($t diag "Addition tests")
    ($t is (+ 1 2)     3       "... 1 + 2 = 3")
    ($t is (+ 10 20)   30      "... 10 + 20 = 30")
    ($t is (+ 1.5 2.5) 4       "... 1.5 + 2.5 = 4")
    ($t is (+ -5 10)   5       "... -5 + 10 = 5")
    ($t is (+ -5 -3)   -8      "... -5 + -3 = -8")
    ($t is (+ 0 0)     0       "... 0 + 0 = 0")

    ($t diag "Addition tests (infix)")
    ($t is (1 + 2)     3       "... 1 + 2 = 3")
    ($t is (10 + 20)   30      "... 10 + 20 = 30")
    ($t is (1.5 + 2.5) 4       "... 1.5 + 2.5 = 4")
    ($t is (-5 + 10)   5       "... -5 + 10 = 5")
    ($t is (-5 + -3)   -8      "... -5 + -3 = -8")
    ($t is (0 + 0)     0       "... 0 + 0 = 0")

    ($t diag "Subtraction tests")
    ($t is (- 5 3)     2       "... 5 - 3 = 2")
    ($t is (- 3 5)     -2      "... 3 - 5 = -2")
    ($t is (- 10.5 0.5) 10     "... 10.5 - 0.5 = 10")
    ($t is (- 0 5)     -5      "... 0 - 5 = -5")
    ($t is (- -3 -5)   2       "... -3 - -5 = 2")

    ($t diag "Subtraction tests (infix")
    ($t is (5 - 3)     2       "... 5 - 3 = 2")
    ($t is (3 - 5)     -2      "... 3 - 5 = -2")
    ($t is (10.5 - 0.5) 10     "... 10.5 - 0.5 = 10")
    ($t is (0 - 5)     -5      "... 0 - 5 = -5")
    ($t is (-3 - -5)   2       "... -3 - -5 = 2")

    ($t diag "Multiplication tests")
    ($t is (* 3 4)     12      "... 3 * 4 = 12")
    ($t is (* 2.5 4)   10      "... 2.5 * 4 = 10")
    ($t is (* -3 4)    -12     "... -3 * 4 = -12")
    ($t is (* -3 -4)   12      "... -3 * -4 = 12")
    ($t is (* 5 0)     0       "... 5 * 0 = 0")

    ($t diag "Multiplication tests (infix)")
    ($t is (3 * 4)     12      "... 3 * 4 = 12")
    ($t is (2.5 * 4)   10      "... 2.5 * 4 = 10")
    ($t is (-3 * 4)    -12     "... -3 * 4 = -12")
    ($t is (-3 * -4)   12      "... -3 * -4 = 12")
    ($t is (5 * 0)     0       "... 5 * 0 = 0")

    ($t diag "Division tests")
    ($t is (/ 10 2)    5       "... 10 / 2 = 5")
    ($t is (/ 7 2)     3.5     "... 7 / 2 = 3.5")
    ($t is (/ 1 4)     0.25    "... 1 / 4 = 0.25")
    ($t is (/ -10 2)   -5      "... -10 / 2 = -5")
    ($t is (/ 0 5)     0       "... 0 / 5 = 0")

    ($t diag "Division tests (infix)")
    ($t is (10 / 2)    5       "... 10 / 2 = 5")
    ($t is (7 / 2)     3.5     "... 7 / 2 = 3.5")
    ($t is (1 / 4)     0.25    "... 1 / 4 = 0.25")
    ($t is (-10 / 2)   -5      "... -10 / 2 = -5")
    ($t is (0 / 5)     0       "... 0 / 5 = 0")

    ($t diag "Modulo tests")
    ($t is (% 10 3)    1       "... 10 % 3 = 1")
    ($t is (% 15 5)    0       "... 15 % 5 = 0")
    ($t is (% 7 4)     3       "... 7 % 4 = 3")
    ($t is (% 10 10)   0       "... 10 % 10 = 0")

    ($t diag "Modulo tests (infix)")
    ($t is (10 % 3)    1       "... 10 % 3 = 1")
    ($t is (15 % 5)    0       "... 15 % 5 = 0")
    ($t is (7 % 4)     3       "... 7 % 4 = 3")
    ($t is (10 % 10)   0       "... 10 % 10 = 0")

    ($t diag "Nested arithmetic tests")
    ($t is (+ 1 (* 2 3))               7   "... 1 + (2 * 3) = 7")
    ($t is (* (+ 1 2) (+ 3 4))         21  "... (1+2) * (3+4) = 21")
    ($t is (- (* 10 10) (+ 50 50))     0   "... (10*10) - (50+50) = 0")
    ($t is (/ (+ 10 20) (- 10 5))      6   "... (10+20) / (10-5) = 6")
    ($t is (* 2 (- 20 5))              30  "... 2 * (20-5) = 30")
    ($t is (* 2 (- (* 10 2) 5))        30  "... 2 * ((10*2)-5) = 30")
    ($t is (* (- 3.2 1.2) (- (* 10 2) 5)) 30 "... (3.2-1.2) * ((10*2)-5) = 30")

    ($t diag "Nested arithmetic tests (infix)")
    ($t is (1 + (2 * 3))               7   "... 1 + (2 * 3) = 7")
    ($t is ((1 + 2) * (3 + 4))         21  "... (1+2) * (3+4) = 21")
    ($t is ((10 * 10) - (50 + 50))     0   "... (10*10) - (50+50) = 0")
    ($t is ((10 + 20) / (10 - 5))      6   "... (10+20) / (10-5) = 6")
    ($t is (2 * (20 - 5))              30  "... 2 * (20-5) = 30")
    ($t is (2 * ((10 * 2) - 5))        30  "... 2 * ((10*2)-5) = 30")
    ($t is (* (3.2 - 1.2) ((10 * 2) - 5)) 30 "... (3.2-1.2) * ((10*2)-5) = 30")

    ($t done)
];

my $kont = MXCL::Machine->new->load($source)->run;
unless ($kont->effect isa MXCL::Effect::Halt) {
    die "EXPECTED HALT, GOT! ", $kont->stringify;
}
