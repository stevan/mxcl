
(defclass Tester ()

    (defvar *count* 0)
    (defvar *fails* 0)

    (defun diag ($t msg) (say "# " msg))

    (defun todo ($t msg)
        ($t diag (~ "TODO:" msg)))

    (defun pass ($t msg)
        (do
            (set! *count* (+ *count* 1))
            (say "ok " (stringify *count*) " - " msg)
            ()))

    (defun fail ($t msg)
        (do
            (set! *count* (+ *count* 1))
            (set! *fails* (+ *fails* 1))
            (say "not ok " *count* " - " msg)
            ()))

    (defun ok ($t test msg)
        (if (boolify test) ($t pass msg) ($t fail msg)))

    (defun is ($t got expected msg)
        (let (result (eq? got expected))
            (do ($t ok result msg)
                (or result
                    (do
                        ($t diag (~ "Failed test " msg))
                        ($t diag (~ "       got: " got))
                        ($t diag (~ "  expected: " expected)))))))

    (defun done ($t)
        (if (!= *fails* 0)
            (do (say (~ "1.." *count*))
                ($t diag (~ (~ "looks like you failed " *fails*)
                         (~ " test(s) of " *count*))))
            (say (~ "1.." *count*))))

)
